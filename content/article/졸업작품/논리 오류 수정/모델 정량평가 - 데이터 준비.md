---
date: '2025-07-25T14:40:16+09:00'
draft: false
linkTitle: '모델 정량평가1'
title: '모델 정량평가 - 데이터 준비'
weight: 5
---

2년 전 만들어둔 AI 모델의 제대로된 성능을 수치로 이제야 측정해보기로 했다.

초기에는 단순히 BLEU, xMatch 같은 정형적인 평가 지표만 사용했었는데,
이는 알고리즘 문제에서 **논리 오류를 고치는 태스크**의 성격과는 맞지 않았다.

그래서 이번에는 다음과 같은 지표로 성능을 다시 측정하기 위해 모델 추론결과를 생성하고 채점을 진행했다.

* **pass@1**: 생성된 코드가 실제 테스트 케이스를 통과했는지 여부
* **코드 유사도**: 코드를 얼마나 최소한으로 수정했는지를 판단
    * **AST 유사도**: 수정 전·후 코드의 추상 구문 트리 유사도
    * **LineDiffRatio**: 전체 코드 대비 라인 단위 수정량을 비교

## 평가 데이터 구축

### 문제 집합 확보

모델이 생성한 코드를 채점하기 위해서는 **문제별 테스트 케이스**가 필요하다.
과거 온라인 저지 백엔드를 개발하면서 초기 문제 세트로 정리해둔 자료가 있어 이를 그대로 사용할 수 있었다.

파일 구조는 다음과 같다:

```
task_detail.json
TC/
├── <문제 번호>/
│   ├── input/
│   │   └── 1.txt
│   └── output/
│       └── 1.txt
```

GitHub에 업로드된 문제 세트로부터 쉽게 채점 환경을 구성할 수 있었다.

![깃허브에 올려둔 기본 문제셋](기본문제셋_테스트케이스.png)

### bug - fixed 코드 페어 확보

모델 평가에 사용할 bug-fixed code pair는 과거 학습 데이터 생성 시 작성했던 Jupyter Notebook을 다시 활용해 재생성했다.

`base_task_set`에 존재하는 문제들만 필터링하여 총 34만개의 데이터를 구했다.

```bash
총 데이터 수: 342,556
상위 3개 문제 유형:
- p02659: 13,103개
- p02743: 7,211개
- p02761: 7,076개
하위 3개 문제 유형:
- p03635: 108개
- p03315: 110개
- p00001: 111개
문제당 평균 개수: 약 827.43개
```

다양한 문제 유형에서 오류 수정 능력을 평가할 수 있도록 구성했다.

## Fixed code 생성

기존에 만들었던 추론 모듈을 수정해, bug code에 대한 fixed code를 일괄 생성하는 과정을 구성했다.
채점은 CPU에서도 가능하지만, fixed code 생성을 위한 추론은 GPU 자원이 필요했기 때문에
**생성과 채점을 별도로 분리하여 실행**하도록 구성했다.

생성된 fixed code는 다음과 같은 형식의 `.jsonl` 파일로 저장했다:

```
{
  "pred": <생성된 코드>,
  "target": <정답 코드>,
  "source": <오답 코드>,
  "p_name": <문제 번호>
}
```

### 추론 환경 구성

처음에는 Colab 무료 인스턴스로 추론을 실행했지만, 전체 34만 건의 데이터를 처리하기에는 시간이 부족했다.
그래서 예전에 SSAFY에서 학습용으로 사용했던 **Vast.ai**를 다시 활용하기로 했다.

Vast 계정에 남아있던 $39.11 크레딧 덕분에 추가 결제 없이 사용할 수 있었다.  
![vast_ai_남은크레딧](vast_ai_남은크레딧.png)

모델 구조가 가볍기 때문에, 가장 저렴한 **RTX 3060 Ti 인스턴스**를 선택했다.
Colab과 동일한 PyTorch, CUDA, cuDNN 버전을 설정해 환경을 구성했다.
![인스턴스_템플릿_수정](인스턴스_템플릿_수정.png)
![vast_ai_인스턴스](vast_ai_인스턴스.png)

총 34만 건의 bug code에 대해 fixed code 생성을 완료하는 데 약 10~14일이 소요되었다.

## 코드 채점
생성된 fixed code는 앞서 확보한 테스트 케이스로 자동 채점을 수행했다.
```bash
...
💾 저장됨: 141600개까지 완료
[141601][p02717] ✅ Passed | ✅ 80016 / ❌ 61585
[141602][p02717] ✅ Passed | ✅ 80017 / ❌ 61585
[141603][p02717] ✅ Passed | ✅ 80018 / ❌ 61585
...
🎯 전체 평가 완료
```

채점 결과는 아래와 같이 저장된다:
```
[
  {
    "p_name": "p03095",
    "result": "pass",
    "pred": <생성 코드>,
    "target": <정답 코드>,
    "source": <오답 코드>
  },
  {
    "p_name": "p03095",
    "result": "fail",
    "pred": <생성 코드>,
    "target": <정답 코드>,
    "source": <오답 코드>,
    "failures": [
      {
        "test_id": 0,
        "reason": "[ERROR] Runtime Error"
      }
    ]
  }
]
```
실패한 경우에는 어떤 테스트 케이스에서 어떤 이유로 실패했는지까지 기록해 두었다.

## 분석

최종적으로 340,922개의 fixed code 샘플에 대한 채점 결과를 확보했다.

다음 글에서:

* pass\@1 비율 확인
* pass 된 코드에 대한 AST 유사도 측정
* LineDiffRatio 분석

을 수행할 예정이다.